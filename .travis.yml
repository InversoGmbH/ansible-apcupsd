---
language: python
python: "2.7"

before_install:
  - sudo apt-get update --assume-yes -qq
  - sudo apt-get install --assume-yes -qq python-apt python-pycurl

install:
  # Install Ansible
  - sudo pip install ansible
  - sudo pip install ansible-lint
  # Add ansible.cfg to pick up roles path
  - cp tests/ansible.cfg ./

script:
  - ansible --version
  # Check the role/playbook's syntax
  - ansible-playbook --inventory-file tests/hosts --syntax-check tests/test.yml
  # Check ansible lint
  - tips=$(ansible-lint --nocolor -p .); echo "ansible-lint has detected '$(echo "$tips" | wc --lines)' improvable thing(s) in role"
  # Run the role/playbook with ansible-playbook
  - ansible-playbook --inventory-file tests/hosts --connection=local --sudo -vvvv tests/playbook.yml
  # Run the role/playbook again, checking to make sure it's idempotent.
  - >
    ansible-playbook --inventory-file tests/hosts --connection=local --sudo tests/playbook.yml | grep --quiet 'changed=0.*failed=0'
    && (echo 'Idempotence test: pass' && exit 0)
    || (echo 'Idempotence test: fail' && exit 1)
